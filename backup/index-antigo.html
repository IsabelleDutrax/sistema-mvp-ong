<!DOCTYPE html>
<!-- // index primeira versao  -->
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>MVP Doa√ß√µes</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="./style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="text-center">
      <h1>üí∞ MVP Doa√ß√µes - Supabase</h1>
      <p>Sistema de Prospec√ß√£o de Doa√ß√µes</p>
    </div>

    <!-- Login / Signup -->
    <div id="auth-section" class="section text-center">
      <div class="mb-2">
        <h2>Login</h2>
      </div>
      <div class="auth-inputs-column">
        <input type="email" id="email" placeholder="Email" />
        <br />
        <input class="mt-1" type="password" id="password" placeholder="Senha" />
      </div>

      <!-- <button onclick="signUp()">Cadastrar</button> -->
      <button class="bg-orange" onclick="signIn()">Entrar</button>
      <button id="sair-btn" class="hidden" onclick="signOut()">
        <i class="fa-solid fa-right-from-bracket"></i> Sair
      </button>
      <!-- <hr> -->
      <div class="mt-1">
        <p class="mb-1">Credenciais de teste:</p>
        <span><b>Admin:</b> admin@admin.com / 123456</span> <br />
        <span><b>Usu√°rio:</b> teste@sistema.com / 123456</span>
      </div>
    </div>

    <!-- Doadores -->
    <div id="doador-section" class="section hidden">
      <div class="mb-2">
        <h2>Doadores</h2>
        <p>Gerencie os doadores da organiza√ß√£o</p>
      </div>
      <input type="text" id="doadorNome" placeholder="Nome" />
      <input type="text" id="doadorTelefone" placeholder="Telefone" />
      <input type="text" id="doadorCpf" placeholder="CPF/CNPJ" />
      <input type="text" id="doadorEndereco" placeholder="Endere√ßo" />
      <button onclick="addDoador()">Adicionar</button>
      <table id="doadorTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Doa√ß√µes -->
    <div id="doacao-section" class="section hidden">
      <div class="mb-2">
        <h2>Doa√ß√µes</h2>
        <p>Gerencie as doa√ß√µes recebidas</p>
      </div>
      <input type="number" id="doacaoValor" placeholder="Valor" />
      <input type="date" id="doacaoData" />
      <input type="text" id="doacaoForma" placeholder="Forma de Pagamento" />
      <button onclick="addDoacao()">Adicionar</button>
      <table id="doacaoTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Doador</th>
            <th>Valor</th>
            <th>Data</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Intera√ß√µes -->
    <div id="interacao-section" class="section hidden">
      <div class="mb-2">
        <h2>Intera√ß√µes</h2>
        <p>Registre contatos e intera√ß√µes com doadores</p>
      </div>
      <input type="text" id="tipoInteracao" placeholder="Tipo" />
      <input type="text" id="observacoes" placeholder="Observa√ß√µes" />
      <button onclick="addInteracao()">Adicionar</button>
      <table id="interacaoTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Doador ID</th>
            <th>Tipo</th>
            <th>Obs</th>
            <th>Data</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      // üîë Config Supabase
      const SUPABASE_URL = "https://iqtxmepahwyqngibdabt.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxdHhtZXBhaHd5cW5naWJkYWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MzQ2NTcsImV4cCI6MjA3NDMxMDY1N30.fokYHtnx0ulKhrX6HBRp-eQRwgerjqIGcxe6kaEGjAo";
      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

      let currentUser = null;
      let currentDoadorId = null;
      let isAdmin = false;

      // =========================
      // üîê AUTH
      // =========================
      async function signIn() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password,
        });
        if (error) return alert("Erro: " + error.message);

        currentUser = data.user;

        // Checa se o usu√°rio √© admin
        const { data: doadorData } = await supabaseClient
          .from("doador")
          .select("nivel_acesso")
          .eq("id_usuario", currentUser.id)
          .single();

        isAdmin = doadorData && doadorData.nivel_acesso === 99;

        // alert("Login OK! Admin: " + isAdmin);
        console.log("Login OK! Admin: " + isAdmin);
        Swal.fire({
          icon: "success",
          title: "Login realizado com sucesso",
          toast: true,
          position: "top-right",
          timer: 3000,
          timerProgressBar: true,
          showConfirmButton: false,
        });
        loadData();
        toggleSections(true);
      }

      async function signOut() {
        await supabaseClient.auth.signOut();
        currentUser = null;
        toggleSections(false);
        // alert("Saiu!");
        Swal.fire({
          icon: "success",
          title: "Voc√™ saiu",
          toast: true,
          position: "top-right",
          timer: 3000,
          timerProgressBar: true,
          showConfirmButton: false,
        });
      }

      function toggleSections(show) {
        document
          .getElementById("doador-section")
          .classList.toggle("hidden", !show);
        document
          .getElementById("doacao-section")
          .classList.toggle("hidden", !show);
        document
          .getElementById("interacao-section")
          .classList.toggle("hidden", !show);
        document.getElementById("sair-btn").classList.toggle("hidden", !show);
      }

      // =========================
      // üßë DOADOR
      // =========================
      async function loadDoadores() {
        // Admin v√™ todos, usu√°rio comum s√≥ os dele
        let query = supabaseClient.from("doador").select("*");
        if (!isAdmin) query = query.eq("id_usuario", currentUser.id);

        const { data, error } = await query;
        if (error) return console.error(error);

        const tbody = document.querySelector("#doadorTable tbody");
        tbody.innerHTML = "";
        data.forEach((d) => {
          tbody.innerHTML += `<tr>
      <td>${d.id_doador}</td>
      <td>${d.nome}</td>
      <td>${d.email}</td>
      <td>${d.telefone || ""}</td>
      <td>
        <button onclick="setDoador(${d.id_doador})">Selecionar</button>
        ${
          isAdmin
            ? `<button onclick="deleteDoador(${d.id_doador})"><i class="fa-solid fa-trash"></i></button>`
            : ""
        }
      </td>
    </tr>`;
        });
      }

      async function addDoador() {
        const nome = document.getElementById("doadorNome").value;
        const telefone = document.getElementById("doadorTelefone").value;
        const cpf = document.getElementById("doadorCpf").value;
        const endereco = document.getElementById("doadorEndereco").value;

        if (isAdmin) {
          const { error } = await supabaseClient
            .from("doador")
            .insert({ nome, telefone, cpf_cnpj: cpf, endereco });
          if (error) return alert("Erro: " + error.message);
        } else {
          const { error } = await supabaseClient.from("doador").upsert({
            id_usuario: currentUser.id,
            nome,
            telefone,
            cpf_cnpj: cpf,
            endereco,
            email: currentUser.email,
          });
          if (error) return alert("Erro: " + error.message);
        }

        loadDoadores();
      }

      async function deleteDoador(id) {
        if (!isAdmin) return alert("Somente admins podem deletar doadores");
        if (!confirm("Tem certeza que deseja deletar este doador?")) return;
        const { error } = await supabaseClient
          .from("doador")
          .delete()
          .eq("id_doador", id);
        if (error) return alert("Erro: " + error.message);
        loadDoadores();
      }

      function setDoador(id) {
        currentDoadorId = id;
        loadDoacoes();
        loadInteracoes();
      }

      // =========================
      // üí∏ DOA√á√ÉO
      // =========================
      async function loadDoacoes() {
        let query = supabaseClient.from("doacao").select("*");
        if (!isAdmin) query = query.eq("id_doador", currentDoadorId);

        const { data, error } = await query;
        if (error) return console.error(error);

        const tbody = document.querySelector("#doacaoTable tbody");
        tbody.innerHTML = "";
        data.forEach((d) => {
          tbody.innerHTML += `<tr>
        <td>${d.id_doacao}</td>
        <td>${d.id_doador}</td>
        <td class="text-green">R$ ${d.valor}</td>
        <td>${d.data_doacao}</td>
        <td>${d.status}</td>
        <td class="text-center">
          <button onclick="updateDoacao(${
            d.id_doacao
          })"> <i class="fa-regular fa-pen-to-square"></i></button>
          ${
            isAdmin
              ? `<button onclick="deleteDoacao(${d.id_doacao})"> <i class="fa-solid fa-trash"></i></button>`
              : ""
          }
        </td>
      </tr>`;
        });
      }

      async function addDoacao() {
        const valor = document.getElementById("doacaoValor").value;
        const dataDoacao = document.getElementById("doacaoData").value;
        const forma = document.getElementById("doacaoForma").value;

        if (!currentDoadorId && !isAdmin) return alert("Selecione um doador!");
        const idDoador = isAdmin ? currentDoadorId || 0 : currentDoadorId;

        const { error } = await supabaseClient.from("doacao").insert({
          id_doador: idDoador,
          valor,
          data_doacao: dataDoacao,
          forma_pagamento: forma,
        });
        if (error) return alert("Erro: " + error.message);
        loadDoacoes();
      }

      async function updateDoacao(id) {
        const valor = prompt("Novo valor:");
        const forma = prompt("Nova forma de pagamento:");
        const status = prompt("Novo status:");
        const { error } = await supabaseClient
          .from("doacao")
          .update({ valor, forma_pagamento: forma, status })
          .eq("id_doacao", id);
        if (error) return alert("Erro: " + error.message);
        loadDoacoes();
      }

      async function deleteDoacao(id) {
        if (!isAdmin) return alert("Somente admins podem deletar doa√ß√µes");
        if (!confirm("Deseja deletar esta doa√ß√£o?")) return;
        const { error } = await supabaseClient
          .from("doacao")
          .delete()
          .eq("id_doacao", id);
        if (error) return alert("Erro: " + error.message);
        loadDoacoes();
      }

      // =========================
      // üìû INTERA√á√ÉO
      // =========================
      async function loadInteracoes() {
        // Admin v√™ todas as intera√ß√µes de todos os doadores
        let query = supabaseClient.from("interacao").select("*");
        if (!isAdmin) query = query.eq("id_doador", currentDoadorId);

        const { data, error } = await query;
        if (error) return console.error(error);

        const tbody = document.querySelector("#interacaoTable tbody");
        tbody.innerHTML = "";
        data.forEach((i) => {
          tbody.innerHTML += `<tr>
      <td>${i.id_interacao}</td>
      <td>${i.id_doador}</td>
      <td>${i.tipo_interacao}</td>
      <td>${i.observacoes || ""}</td>
      <td>${i.data_interacao}</td>
      <td class="text-center">
        <button onclick="updateInteracao(${
          i.id_interacao
        })"> <i class="fa-regular fa-pen-to-square"></i></button>
        ${
          isAdmin
            ? `<button onclick="deleteInteracao(${i.id_interacao})"> <i class="fa-solid fa-trash"></i></button>`
            : ""
        }
      </td>
    </tr>`;
        });
      }

      async function addInteracao() {
        const tipo = document.getElementById("tipoInteracao").value;
        const obs = document.getElementById("observacoes").value;
        if (!currentDoadorId && !isAdmin) return alert("Selecione um doador!");
        const idDoador = isAdmin ? currentDoadorId || 0 : currentDoadorId;

        const { error } = await supabaseClient.from("interacao").insert({
          id_doador: idDoador,
          id_usuario: currentUser.id,
          tipo_interacao: tipo,
          observacoes: obs,
        });
        if (error) return alert("Erro: " + error.message);
        loadInteracoes();
      }

      async function updateInteracao(id) {
        const tipo = prompt("Novo tipo:");
        const obs = prompt("Nova observa√ß√£o:");
        const { error } = await supabaseClient
          .from("interacao")
          .update({ tipo_interacao: tipo, observacoes: obs })
          .eq("id_interacao", id);
        if (error) return alert("Erro: " + error.message);
        loadInteracoes();
      }

      async function deleteInteracao(id) {
        if (!isAdmin) return alert("Somente admins podem deletar intera√ß√µes");
        if (!confirm("Deseja deletar esta intera√ß√£o?")) return;
        const { error } = await supabaseClient
          .from("interacao")
          .delete()
          .eq("id_interacao", id);
        if (error) return alert("Erro: " + error.message);
        loadInteracoes();
      }

      // =========================
      // üöÄ Load inicial
      // =========================
      async function loadData() {
        await loadDoadores();
        await loadDoacoes();
        await loadInteracoes();
      }
    </script>
  </body>
</html>
